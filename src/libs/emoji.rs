use core::str::utf8_char_width;
use std::{borrow::Cow, sync::OnceLock};

use compact_str::CompactString;
use hashbrown::HashMap;
use pcre2::bytes::{Regex, RegexBuilder};

const MULTICP_DATA: [(&str, &str); 264] = [
    ("😶‍🌫", "😶‍🌫️"),
    ("😮‍💨", "😮‍💨"),
    ("🙂‍↔", "🙂‍↔️"),
    ("🙂‍↕", "🙂‍↕️"),
    ("😵‍💫", "😵‍💫"),
    ("❤️‍🔥", "❤️‍🔥"),
    ("❤️‍🩹", "❤️‍🩹"),
    ("👁️‍🗨", "👁️‍🗨️"),
    ("🧔‍♂", "🧔‍♂️"),
    ("🧔‍♀", "🧔‍♀️"),
    ("👨‍🦰", "👨‍🦰"),
    ("👨‍🦱", "👨‍🦱"),
    ("👨‍🦳", "👨‍🦳"),
    ("👨‍🦲", "👨‍🦲"),
    ("👩‍🦰", "👩‍🦰"),
    ("🧑‍🦰", "🧑‍🦰"),
    ("👩‍🦱", "👩‍🦱"),
    ("🧑‍🦱", "🧑‍🦱"),
    ("👩‍🦳", "👩‍🦳"),
    ("🧑‍🦳", "🧑‍🦳"),
    ("👩‍🦲", "👩‍🦲"),
    ("🧑‍🦲", "🧑‍🦲"),
    ("👱‍♀", "👱‍♀️"),
    ("👱‍♂", "👱‍♂️"),
    ("🙍‍♂", "🙍‍♂️"),
    ("🙍‍♀", "🙍‍♀️"),
    ("🙎‍♂", "🙎‍♂️"),
    ("🙎‍♀", "🙎‍♀️"),
    ("🙅‍♂", "🙅‍♂️"),
    ("🙅‍♀", "🙅‍♀️"),
    ("🙆‍♂", "🙆‍♂️"),
    ("🙆‍♀", "🙆‍♀️"),
    ("💁‍♂", "💁‍♂️"),
    ("💁‍♀", "💁‍♀️"),
    ("🙋‍♂", "🙋‍♂️"),
    ("🙋‍♀", "🙋‍♀️"),
    ("🧏‍♂", "🧏‍♂️"),
    ("🧏‍♀", "🧏‍♀️"),
    ("🙇‍♂", "🙇‍♂️"),
    ("🙇‍♀", "🙇‍♀️"),
    ("🤦‍♂", "🤦‍♂️"),
    ("🤦‍♀", "🤦‍♀️"),
    ("🤷‍♂", "🤷‍♂️"),
    ("🤷‍♀", "🤷‍♀️"),
    ("🧑‍⚕", "🧑‍⚕️"),
    ("👨‍⚕", "👨‍⚕️"),
    ("👩‍⚕", "👩‍⚕️"),
    ("🧑‍🎓", "🧑‍🎓"),
    ("👨‍🎓", "👨‍🎓"),
    ("👩‍🎓", "👩‍🎓"),
    ("🧑‍🏫", "🧑‍🏫"),
    ("👨‍🏫", "👨‍🏫"),
    ("👩‍🏫", "👩‍🏫"),
    ("🧑‍⚖", "🧑‍⚖️"),
    ("👨‍⚖", "👨‍⚖️"),
    ("👩‍⚖", "👩‍⚖️"),
    ("🧑‍🌾", "🧑‍🌾"),
    ("👨‍🌾", "👨‍🌾"),
    ("👩‍🌾", "👩‍🌾"),
    ("🧑‍🍳", "🧑‍🍳"),
    ("👨‍🍳", "👨‍🍳"),
    ("👩‍🍳", "👩‍🍳"),
    ("🧑‍🔧", "🧑‍🔧"),
    ("👨‍🔧", "👨‍🔧"),
    ("👩‍🔧", "👩‍🔧"),
    ("🧑‍🏭", "🧑‍🏭"),
    ("👨‍🏭", "👨‍🏭"),
    ("👩‍🏭", "👩‍🏭"),
    ("🧑‍💼", "🧑‍💼"),
    ("👨‍💼", "👨‍💼"),
    ("👩‍💼", "👩‍💼"),
    ("🧑‍🔬", "🧑‍🔬"),
    ("👨‍🔬", "👨‍🔬"),
    ("👩‍🔬", "👩‍🔬"),
    ("🧑‍💻", "🧑‍💻"),
    ("👨‍💻", "👨‍💻"),
    ("👩‍💻", "👩‍💻"),
    ("🧑‍🎤", "🧑‍🎤"),
    ("👨‍🎤", "👨‍🎤"),
    ("👩‍🎤", "👩‍🎤"),
    ("🧑‍🎨", "🧑‍🎨"),
    ("👨‍🎨", "👨‍🎨"),
    ("👩‍🎨", "👩‍🎨"),
    ("🧑‍✈", "🧑‍✈️"),
    ("👨‍✈", "👨‍✈️"),
    ("👩‍✈", "👩‍✈️"),
    ("🧑‍🚀", "🧑‍🚀"),
    ("👨‍🚀", "👨‍🚀"),
    ("👩‍🚀", "👩‍🚀"),
    ("🧑‍🚒", "🧑‍🚒"),
    ("👨‍🚒", "👨‍🚒"),
    ("👩‍🚒", "👩‍🚒"),
    ("👮‍♂", "👮‍♂️"),
    ("👮‍♀", "👮‍♀️"),
    ("🕵️‍♂", "🕵️‍♂️"),
    ("🕵️‍♀", "🕵️‍♀️"),
    ("💂‍♂", "💂‍♂️"),
    ("💂‍♀", "💂‍♀️"),
    ("👷‍♂", "👷‍♂️"),
    ("👷‍♀", "👷‍♀️"),
    ("👳‍♂", "👳‍♂️"),
    ("👳‍♀", "👳‍♀️"),
    ("🤵‍♂", "🤵‍♂️"),
    ("🤵‍♀", "🤵‍♀️"),
    ("👰‍♂", "👰‍♂️"),
    ("👰‍♀", "👰‍♀️"),
    ("👩‍🍼", "👩‍🍼"),
    ("👨‍🍼", "👨‍🍼"),
    ("🧑‍🍼", "🧑‍🍼"),
    ("🧑‍🎄", "🧑‍🎄"),
    ("🦸‍♂", "🦸‍♂️"),
    ("🦸‍♀", "🦸‍♀️"),
    ("🦹‍♂", "🦹‍♂️"),
    ("🦹‍♀", "🦹‍♀️"),
    ("🧙‍♂", "🧙‍♂️"),
    ("🧙‍♀", "🧙‍♀️"),
    ("🧚‍♂", "🧚‍♂️"),
    ("🧚‍♀", "🧚‍♀️"),
    ("🧛‍♂", "🧛‍♂️"),
    ("🧛‍♀", "🧛‍♀️"),
    ("🧜‍♂", "🧜‍♂️"),
    ("🧜‍♀", "🧜‍♀️"),
    ("🧝‍♂", "🧝‍♂️"),
    ("🧝‍♀", "🧝‍♀️"),
    ("🧞‍♂", "🧞‍♂️"),
    ("🧞‍♀", "🧞‍♀️"),
    ("🧟‍♂", "🧟‍♂️"),
    ("🧟‍♀", "🧟‍♀️"),
    ("💆‍♂", "💆‍♂️"),
    ("💆‍♀", "💆‍♀️"),
    ("💇‍♂", "💇‍♂️"),
    ("💇‍♀", "💇‍♀️"),
    ("🚶‍♂", "🚶‍♂️"),
    ("🚶‍♀", "🚶‍♀️"),
    ("🚶‍➡", "🚶‍➡️"),
    ("🚶‍♀️‍➡", "🚶‍♀️‍➡️"),
    ("🚶‍♂️‍➡", "🚶‍♂️‍➡️"),
    ("🧍‍♂", "🧍‍♂️"),
    ("🧍‍♀", "🧍‍♀️"),
    ("🧎‍♂", "🧎‍♂️"),
    ("🧎‍♀", "🧎‍♀️"),
    ("🧎‍➡", "🧎‍➡️"),
    ("🧎‍♀️‍➡", "🧎‍♀️‍➡️"),
    ("🧎‍♂️‍➡", "🧎‍♂️‍➡️"),
    ("🧑‍🦯", "🧑‍🦯"),
    ("🧑‍🦯‍➡", "🧑‍🦯‍➡️"),
    ("👨‍🦯", "👨‍🦯"),
    ("👨‍🦯‍➡", "👨‍🦯‍➡️"),
    ("👩‍🦯", "👩‍🦯"),
    ("👩‍🦯‍➡", "👩‍🦯‍➡️"),
    ("🧑‍🦼", "🧑‍🦼"),
    ("🧑‍🦼‍➡", "🧑‍🦼‍➡️"),
    ("👨‍🦼", "👨‍🦼"),
    ("👨‍🦼‍➡", "👨‍🦼‍➡️"),
    ("👩‍🦼", "👩‍🦼"),
    ("👩‍🦼‍➡", "👩‍🦼‍➡️"),
    ("🧑‍🦽", "🧑‍🦽"),
    ("🧑‍🦽‍➡", "🧑‍🦽‍➡️"),
    ("👨‍🦽", "👨‍🦽"),
    ("👨‍🦽‍➡", "👨‍🦽‍➡️"),
    ("👩‍🦽", "👩‍🦽"),
    ("👩‍🦽‍➡", "👩‍🦽‍➡️"),
    ("🏃‍♂", "🏃‍♂️"),
    ("🏃‍♀", "🏃‍♀️"),
    ("🏃‍➡", "🏃‍➡️"),
    ("🏃‍♀️‍➡", "🏃‍♀️‍➡️"),
    ("🏃‍♂️‍➡", "🏃‍♂️‍➡️"),
    ("🧑‍🩰", "🧑‍🩰"),
    ("👯‍♂", "👯‍♂️"),
    ("👯‍♀", "👯‍♀️"),
    ("🧖‍♂", "🧖‍♂️"),
    ("🧖‍♀", "🧖‍♀️"),
    ("🧗‍♂", "🧗‍♂️"),
    ("🧗‍♀", "🧗‍♀️"),
    ("🏌️‍♂", "🏌️‍♂️"),
    ("🏌️‍♀", "🏌️‍♀️"),
    ("🏄‍♂", "🏄‍♂️"),
    ("🏄‍♀", "🏄‍♀️"),
    ("🚣‍♂", "🚣‍♂️"),
    ("🚣‍♀", "🚣‍♀️"),
    ("🏊‍♂", "🏊‍♂️"),
    ("🏊‍♀", "🏊‍♀️"),
    ("⛹️‍♂", "⛹️‍♂️"),
    ("⛹️‍♀", "⛹️‍♀️"),
    ("🏋️‍♂", "🏋️‍♂️"),
    ("🏋️‍♀", "🏋️‍♀️"),
    ("🚴‍♂", "🚴‍♂️"),
    ("🚴‍♀", "🚴‍♀️"),
    ("🚵‍♂", "🚵‍♂️"),
    ("🚵‍♀", "🚵‍♀️"),
    ("🤸‍♂", "🤸‍♂️"),
    ("🤸‍♀", "🤸‍♀️"),
    ("🤼‍♂", "🤼‍♂️"),
    ("🤼‍♀", "🤼‍♀️"),
    ("🤽‍♂", "🤽‍♂️"),
    ("🤽‍♀", "🤽‍♀️"),
    ("🤾‍♂", "🤾‍♂️"),
    ("🤾‍♀", "🤾‍♀️"),
    ("🤹‍♂", "🤹‍♂️"),
    ("🤹‍♀", "🤹‍♀️"),
    ("🧘‍♂", "🧘‍♂️"),
    ("🧘‍♀", "🧘‍♀️"),
    ("🧑‍🤝‍🧑", "🧑‍🤝‍🧑"),
    ("👩‍❤️‍💋‍👨", "👩‍❤️‍💋‍👨"),
    ("👨‍❤️‍💋‍👨", "👨‍❤️‍💋‍👨"),
    ("👩‍❤️‍💋‍👩", "👩‍❤️‍💋‍👩"),
    ("👩‍❤️‍👨", "👩‍❤️‍👨"),
    ("👨‍❤️‍👨", "👨‍❤️‍👨"),
    ("👩‍❤️‍👩", "👩‍❤️‍👩"),
    ("👨‍👩‍👦", "👨‍👩‍👦"),
    ("👨‍👩‍👧", "👨‍👩‍👧"),
    ("👨‍👩‍👧‍👦", "👨‍👩‍👧‍👦"),
    ("👨‍👩‍👦‍👦", "👨‍👩‍👦‍👦"),
    ("👨‍👩‍👧‍👧", "👨‍👩‍👧‍👧"),
    ("👨‍👨‍👦", "👨‍👨‍👦"),
    ("👨‍👨‍👧", "👨‍👨‍👧"),
    ("👨‍👨‍👧‍👦", "👨‍👨‍👧‍👦"),
    ("👨‍👨‍👦‍👦", "👨‍👨‍👦‍👦"),
    ("👨‍👨‍👧‍👧", "👨‍👨‍👧‍👧"),
    ("👩‍👩‍👦", "👩‍👩‍👦"),
    ("👩‍👩‍👧", "👩‍👩‍👧"),
    ("👩‍👩‍👧‍👦", "👩‍👩‍👧‍👦"),
    ("👩‍👩‍👦‍👦", "👩‍👩‍👦‍👦"),
    ("👩‍👩‍👧‍👧", "👩‍👩‍👧‍👧"),
    ("👨‍👦", "👨‍👦"),
    ("👨‍👦‍👦", "👨‍👦‍👦"),
    ("👨‍👧", "👨‍👧"),
    ("👨‍👧‍👦", "👨‍👧‍👦"),
    ("👨‍👧‍👧", "👨‍👧‍👧"),
    ("👩‍👦", "👩‍👦"),
    ("👩‍👦‍👦", "👩‍👦‍👦"),
    ("👩‍👧", "👩‍👧"),
    ("👩‍👧‍👦", "👩‍👧‍👦"),
    ("👩‍👧‍👧", "👩‍👧‍👧"),
    ("🧑‍🧑‍🧒", "🧑‍🧑‍🧒"),
    ("🧑‍🧑‍🧒‍🧒", "🧑‍🧑‍🧒‍🧒"),
    ("🧑‍🧒", "🧑‍🧒"),
    ("🧑‍🧒‍🧒", "🧑‍🧒‍🧒"),
    ("🐕‍🦺", "🐕‍🦺"),
    ("🐈‍⬛", "🐈‍⬛"),
    ("🐻‍❄", "🐻‍❄️"),
    ("🐦‍⬛", "🐦‍⬛"),
    ("🐦‍🔥", "🐦‍🔥"),
    ("🍋‍🟩", "🍋‍🟩"),
    ("🍄‍🟫", "🍄‍🟫"),
    ("⛓️‍💥", "⛓️‍💥"),
    ("🏳️‍🌈", "🏳️‍🌈"),
    ("🏳️‍⚧", "🏳️‍⚧️"),
    ("🏴‍☠", "🏴‍☠️"),
    ("🏴󠁧󠁢󠁥󠁮󠁧󠁿", "🏴󠁧󠁢󠁥󠁮󠁧󠁿"),
    ("🏴󠁧󠁢󠁳󠁣󠁴󠁿", "🏴󠁧󠁢󠁳󠁣󠁴󠁿"),
    ("🏴󠁧󠁢󠁷󠁬󠁳󠁿", "🏴󠁧󠁢󠁷󠁬󠁳󠁿"),
    /* ======== Normalize strengthen ! ======== */
    ("👨‍🐰‍👨", "👯‍♂️"),
    ("👩‍🐰‍👩", "👯‍♀️"),
    ("👨‍🤝‍👨", "👬"),
    ("👩‍🤝‍👨", "👫"),
    ("👩‍🤝‍👩", "👭"),
    ("👨‍🫯‍👨", "🤼‍♂️"),
    ("👩‍🫯‍👩", "🤼‍♀️"),
    ("🧑‍🐰‍🧑", "👯"),
    ("🧑‍🫯‍🧑", "🤼"),
    ("🧑‍❤️‍💋‍🧑", "💏"),
    ("🧑‍❤️‍🧑", "💑"),
    ("🫱‍🫲", "🤝"),
];

static EMOJI: OnceLock<Regex> = OnceLock::new();
static MULTICP: OnceLock<HashMap<&'static str, &'static str>> = OnceLock::new();

const fn is_race(c: char) -> bool {
    matches!(c, '🏻'..='🏿')
}

const fn is_alt(c: char) -> bool {
    matches!(c, '⛹' | '🏋' | '🏌' | '🕴' | '🕵')
}

fn remove_race(s: &str) -> Cow<'_, str> {
    if !s.chars().skip(1).any(is_race) { return Cow::Borrowed(s); }
    let mut iter = s.chars();
    let mut ret = String::with_capacity(s.len());
    let mut last = unsafe { iter.next().unwrap_unchecked() };
    ret.push(last);
    for ch in iter {
        if !is_race(ch) {
            ret.push(ch);
        } else if is_alt(last) {
            ret.push('️');
        }
        last = ch;
    }
    Cow::Owned(ret)
}

fn with_️(s: &str) -> CompactString {
    let mut t = CompactString::with_capacity(s.len() + 3);
    t.push_str(s);
    t.push_str("️");
    t
}

fn single_codepoint(s: &str) -> Option<CompactString> {
    #[cfg(feature = "build-std")]
    let v = unsafe { EMOJI.get_unchecked().is_match(s.as_bytes()) };
    #[cfg(not(feature = "build-std"))]
    let v = unsafe { EMOJI.get().unwrap_unchecked().is_match(s.as_bytes()) };
    let Ok(true) = v else { return None };
    match s {
        "©" | "®" | "™" | "♟" => Some(with_️(s)),
        _ => Some(s.into()),
    }
}

fn multi_codepoint(s: &str) -> Option<CompactString> {
    #[cfg(feature = "build-std")]
    let v = unsafe { MULTICP.get_unchecked().get(s) };
    #[cfg(not(feature = "build-std"))]
    let v = unsafe { MULTICP.get().unwrap_unchecked().get(s) };
    v.map(|&s| s.into())
}

pub fn normalize(s: &str) -> Option<CompactString> {
    let s_ = remove_race(s.trim());
    let mut s = &*s_;
    while let Some(t) = s.strip_suffix("️") {
        s = t;
    }
    let &b = s.as_bytes().first()?;
    if matches!(b, b'#' | b'*' | b'0'..=b'9') {
        return Some(unsafe { CompactString::from_utf8_unchecked([b, 0xef, 0xb8, 0x8f, 0xe2, 0x83, 0xa3]) })
    }
    let w = utf8_char_width(b);
    if s.len() == w {
        single_codepoint(s)
    } else {
        multi_codepoint(s)
    }
}

pub fn init() {
    let emoji = RegexBuilder::new()
        .jit_if_available(true)
        .ucp(true)
        // .build(r"^\p{RGI_Emoji}$")
        .build(r"^\p{Emoji}$")
        .unwrap();
    #[cfg(debug_assertions)]
    {
        for (s, _) in MULTICP_DATA {
            assert!(s.chars().count() > 2);
            assert!(!s.ends_with("️"));
        }
    }
    let multicp = HashMap::from(MULTICP_DATA);
    EMOJI.get_or_init(|| emoji);
    MULTICP.get_or_init(|| multicp);
}
